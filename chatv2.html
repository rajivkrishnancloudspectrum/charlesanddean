<script>
let pendingMessage = null;
let firstMessageHandled = false;

function hideHome(){ document.getElementById('chat-container').style.display='none'; }
function showHome(){ document.getElementById('chat-container').style.display='block'; }

function makeMessagingFullScreen(){
    const interval=setInterval(()=>{
        const frame=document.querySelector('.embeddedMessagingFrame');
        if(frame){
            frame.style.width="100vw";
            frame.style.height="100vh";
            clearInterval(interval);
        }
    },200);
}

function initEmbeddedMessaging(){
    try{
        embeddedservice_bootstrap.settings.language='en_US';
        embeddedservice_bootstrap.settings.hideChatButtonOnLoad=true;

        embeddedservice_bootstrap.init(
            '00DTA00000B1e6j',
            'Web_AI_Agent',
            'https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563',
            { scrt2URL:'https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com' }
        );
    }catch(err){
        console.error(err);
    }
}

window.addEventListener("onEmbeddedMessagingReady", () => {
    console.log("âœ… Embedded Messaging Ready");

    window.addEventListener("onEmbeddedMessagingConversationOpened",()=>{
        console.log("Chat opened");
        hideHome();
        makeMessagingFullScreen();
    });

    window.addEventListener("onEmbeddedMessagingWindowClosed",()=>{
        console.log("Chat closed");
        showHome();
        firstMessageHandled = false;
        pendingMessage = null;
    });

    window.addEventListener("onEmbeddedMessagingWindowMinimized",()=>{
        console.log("Chat minimized");
        showHome();
    });

    // ðŸ”¥ CORRECT DETECTION â€” first real response
    window.addEventListener(
      "onEmbeddedMessagingMessageReceived",
      (event) => {

        console.group("ðŸ“© Message Received");
        console.log("event.detail:", event.detail);
        console.groupEnd();

        if(firstMessageHandled) return;

        const sender = event.detail?.conversationEntry?.sender;
        console.log("First message sender:", sender);

        firstMessageHandled = true;

        if(sender?.appType === "agent" && pendingMessage){
            console.log("âœ… Human replied first â€” sending stored message");
            embeddedservice_bootstrap.utilAPI.sendTextMessage(pendingMessage);
            pendingMessage = null;
        } else {
            console.log("â„¹ï¸ First reply was from bot. Waiting for human...");
        }
    });

    [
        "onEmbeddedMessagingMessageSent"
    ].forEach(evt=>{
        window.addEventListener(evt, e=>{
            console.log(`ðŸ“¡ ${evt}`, e.detail);
        });
    });
});

function launchChat(message){
    embeddedservice_bootstrap.utilAPI.launchChat()
        .then(()=>{
            if(message){
                console.log("ðŸ•’ Storing message until first human response");
                pendingMessage = message;
            }
        });
}

document.addEventListener('DOMContentLoaded',()=>{
    const sendBtn=document.getElementById('sendBtn');
    const chatInput=document.getElementById('chatInput');
    const orderButton=document.getElementById('orderButton');
    const caseButton=document.getElementById('caseButton');

    sendBtn.addEventListener('click',()=>{
        const msg=chatInput.value.trim();
        if(msg){
            chatInput.value="";
            launchChat(msg);
        }
    });

    chatInput.addEventListener("keypress",(e)=>{
        if(e.key==="Enter") sendBtn.click();
    });

    orderButton.addEventListener('click',()=>launchChat(orderButton.textContent.trim()));
    caseButton.addEventListener('click',()=>launchChat(caseButton.textContent.trim()));
});
</script>
