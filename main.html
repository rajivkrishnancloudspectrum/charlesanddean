<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Agentforce Debug Portal</title>

<style>
body{margin:0;padding:0;height:100vh;width:100vw;font-family:sans-serif;}
#landing-ui{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
#embeddedMessagingContainer{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff;z-index:9999;display:none;}
#closeChatBtn{
  display:none;
  position:fixed;
  top:20px;
  right:20px;
  z-index:10000;
  background:#202123;
  color:#fff;
  border:none;
  border-radius:50%;
  width:42px;
  height:42px;
  font-size:20px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="landing-ui">
  <h1>Agentforce Debug UI</h1>
  <input id="agentInput" placeholder="Type your request..." />
  <button id="searchBtn" disabled>Send</button>
  <p id="statusMsg">Initializing Agent…</p>
</div>

<div id="embeddedMessagingContainer"></div>
<button id="closeChatBtn">✕</button>

<script>
let capturedInput = "";
let chatLaunched = false;

function log(msg){
  console.log("%c[DEBUG] " + msg, "color:green;font-weight:bold;");
}

/* ================= INIT ESW ================= */
function initEmbeddedMessaging() {

  log("initEmbeddedMessaging() called");

  embeddedservice_bootstrap.settings.language = "en_US";
  embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;

  // ⭐ REQUIRED SETTINGS
  embeddedservice_bootstrap.settings.disableAutoSessionRestore = true;
  embeddedservice_bootstrap.settings.displayMode = "inline";
  embeddedservice_bootstrap.settings.targetElement =
      document.getElementById("embeddedMessagingContainer");

  log("Inline + targetElement + disableAutoSessionRestore set BEFORE init");

  window.addEventListener("onEmbeddedMessagingReady", () => {
    log("Event: onEmbeddedMessagingReady");
    document.getElementById("searchBtn").disabled = false;
    document.getElementById("statusMsg").innerText = "Agent Ready";
  });

  window.addEventListener("onEmbeddedMessagingConversationOpened", () => {
    log("Event: Conversation Opened");

    const wait = setInterval(()=>{
      const frame = document.querySelector(".embeddedMessagingFrame");
      if(frame){
        clearInterval(wait);
        log("Iframe detected in DOM");

        document.getElementById("landing-ui").style.display = "none";
        document.getElementById("embeddedMessagingContainer").style.display = "block";
        document.getElementById("closeChatBtn").style.display = "block";

        if(capturedInput){
          log("Sending message: " + capturedInput);
          embeddedservice_bootstrap.utilAPI.sendTextMessage(capturedInput);
          capturedInput = "";
        }
      }
    },100);
  });

  const restoreUI = (source) => {
    log("Restore UI triggered by: " + source);
    chatLaunched = false;
    document.getElementById("embeddedMessagingContainer").style.display = "none";
    document.getElementById("landing-ui").style.display = "flex";
    document.getElementById("closeChatBtn").style.display = "none";
  };

  window.addEventListener("onEmbeddedMessagingWindowClosed", ()=>restoreUI("WindowClosed"));
  window.addEventListener("onEmbeddedMessagingWindowMinimized", ()=>restoreUI("WindowMinimized"));

  embeddedservice_bootstrap.init(
    "00DTA00000B1e6j",
    "Web_AI_Agent",
    "https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563",
    { scrt2URL: "https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com" }
  );

  log("embeddedservice_bootstrap.init() called");
}

/* ================= USER INTERACTION ================= */
document.addEventListener("DOMContentLoaded", () => {

  log("DOM fully loaded");

  const btn = document.getElementById("searchBtn");
  const input = document.getElementById("agentInput");
  const closeBtn = document.getElementById("closeChatBtn");

  input.addEventListener("input", () => {
    log("Typing: " + input.value);
    btn.disabled = !input.value.trim();
  });

  const startChat = () => {
    log("startChat() triggered");

    if(chatLaunched){
      log("Chat already launched — ignoring");
      return;
    }

    const text = input.value.trim();
    if(!text){
      log("No text entered");
      return;
    }

    capturedInput = text;
    input.value = "";
    chatLaunched = true;

    log("Calling launchChat()");
    embeddedservice_bootstrap.utilAPI.launchChat();
  };

  btn.addEventListener("click", () => {
    log("Send button clicked");
    startChat();
  });

  input.addEventListener("keydown", e => {
    if(e.key === "Enter"){
      log("Enter key pressed");
      startChat();
    }
  });

  // ✅ Proper close behavior
  closeBtn.addEventListener("click", () => {
    log("Custom X clicked → sending 'end' and hiding UI");

    embeddedservice_bootstrap.utilAPI.sendTextMessage("end");

    document.getElementById("embeddedMessagingContainer").style.display = "none";
    document.getElementById("landing-ui").style.display = "flex";
    document.getElementById("closeChatBtn").style.display = "none";

    chatLaunched = false;
  });
});
</script>

<script
src="https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563/assets/js/bootstrap.min.js"
onload="initEmbeddedMessaging()">
</script>

</body>
</html>
