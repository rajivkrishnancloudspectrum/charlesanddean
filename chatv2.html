<!DOCTYPE html>
<html>
<head>
    <title>Charles & Dean Finance Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body{
            margin:0;
            height:100vh;
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            background:#f3f4f6;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        #chat-container{
            width:720px;
            max-width:90%;
            text-align:center;
        }
        .title{ font-size:34px; font-weight:600; color:#0d1b2a; margin-bottom:10px; }
        .subtitle{ color:#6b7280; margin-bottom:30px; font-size:16px; }
        .input-wrapper{
            display:flex; background:white; border-radius:14px;
            box-shadow:0 10px 25px rgba(0,0,0,0.1);
            padding:8px; align-items:center;
        }
        .chat-input{ flex:1; border:none; outline:none; font-size:16px; padding:14px; border-radius:12px; }
        .send-btn{
            background:#0d1b2a; color:white; border:none;
            padding:12px 20px; border-radius:10px;
            cursor:pointer; font-weight:600;
        }
        .quick-options{
            margin-top:28px; display:flex; flex-wrap:wrap;
            gap:12px; justify-content:center;
        }
        .quick-btn{
            padding:10px 16px; border-radius:22px;
            border:1px solid #d1d5db; background:white;
            cursor:pointer; transition:0.2s;
        }
        .quick-btn:hover{
            background:#0d1b2a; color:white; border-color:#0d1b2a;
        }
        .embeddedMessagingFrame{
            position:fixed !important;
            inset:0 !important;
            width:100vw !important;
            height:100vh !important;
            z-index:999999 !important;
        }
        .embeddedMessagingFrame iframe{
            width:100% !important;
            height:100% !important;
        }
    </style>
</head>

<body>

<div id="chat-container">
    <div class="title">Charles & Dean Finance Assistant</div>
    <div class="subtitle">Ask anything about vehicle finance, eligibility or applications</div>

    <div class="input-wrapper">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about vehicle finance..." />
        <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <div class="quick-options">
        <button id="orderButton" class="quick-btn">Need vehicle finance help</button>
        <button id="caseButton" class="quick-btn">Check my eligibility</button>
        <button class="quick-btn" onclick="launchChat('Help me choose the right vehicle finance option')">Help me choose a plan</button>
        <button class="quick-btn" onclick="launchChat('I want to apply for vehicle finance')">Start application</button>
    </div>
</div>

<script>
let pendingMessage = null;
let botGreetingSeen = false;

function hideHome(){ document.getElementById('chat-container').style.display='none'; }
function showHome(){ document.getElementById('chat-container').style.display='block'; }

function makeMessagingFullScreen(){
    const interval=setInterval(()=>{
        const frame=document.querySelector('.embeddedMessagingFrame');
        if(frame){
            frame.style.width="100vw";
            frame.style.height="100vh";
            clearInterval(interval);
        }
    },200);
}

function initEmbeddedMessaging(){
    try{
        embeddedservice_bootstrap.settings.language='en_US';
        embeddedservice_bootstrap.settings.hideChatButtonOnLoad=true;

        embeddedservice_bootstrap.init(
            '00DTA00000B1e6j',
            'Web_AI_Agent',
            'https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563',
            { scrt2URL:'https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com' }
        );
    }catch(err){
        console.error(err);
    }
}

window.addEventListener("onEmbeddedMessagingReady", () => {
    console.log("âœ… Embedded Messaging Ready");

    window.addEventListener("onEmbeddedMessagingConversationOpened",()=>{
        console.log("Chat opened");
        hideHome();
        makeMessagingFullScreen();
    });

    window.addEventListener("onEmbeddedMessagingWindowClosed",()=>{
        console.log("Chat closed");
        botGreetingSeen = false; 
        showHome();
    });

    window.addEventListener("onEmbeddedMessagingWindowMinimized",()=>{
        showHome();
    });

    // Combined Trigger Logic
    window.addEventListener("onEmbeddedMessagingConversationEntry", (event) => {
        const entry = event.detail?.conversationEntry;
        if (!entry) return;

        console.log("ðŸ“© Entry Detected:", entry.entryType);

        // Check if bot joined or sent a message
        const botPresent = (entry.entryType === "Message" && entry.sender?.role !== "EndUser") || 
                           (entry.entryType === "ParticipantChanged");

        if (botPresent && !botGreetingSeen && pendingMessage) {
            console.log("ðŸš€ Bot detected via " + entry.entryType + ". Preparing to send...");
            
            botGreetingSeen = true;

            // Increased delay to 1 second to ensure Salesforce is ready for input
            setTimeout(() => {
                if (pendingMessage) {
                    console.log("ðŸ“¡ Sending message:", pendingMessage);
                    embeddedservice_bootstrap.utilAPI.sendTextMessage(pendingMessage);
                    pendingMessage = null;
                }
            }, 1000);
        }
    });
});

function launchChat(message){
    if(message){
        console.log("ðŸŸ¦ Customer action stored:", message);
        pendingMessage = message; 
        botGreetingSeen = false; 
    }
    embeddedservice_bootstrap.utilAPI.launchChat();
}

document.addEventListener('DOMContentLoaded',()=>{
    const sendBtn = document.getElementById('sendBtn');
    const chatInput = document.getElementById('chatInput');
    const orderButton = document.getElementById('orderButton');
    const caseButton = document.getElementById('caseButton');

    sendBtn.addEventListener('click',()=>{
        const msg = chatInput.value.trim();
        if(msg){
            chatInput.value = "";
            launchChat(msg);
        }
    });

    chatInput.addEventListener("keypress",(e)=>{
        if(e.key === "Enter") sendBtn.click();
    });

    orderButton.addEventListener('click',()=>launchChat(orderButton.textContent.trim()));
    caseButton.addEventListener('click',()=>launchChat(caseButton.textContent.trim()));
});
</script>

<script src='https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563/assets/js/bootstrap.min.js'
        onload='initEmbeddedMessaging()'></script>

</body>
</html>
