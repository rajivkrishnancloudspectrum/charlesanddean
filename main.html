<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Agentforce Clean Working Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  height:100vh;
  font-family:sans-serif;
  background:#f4f6f9;
}
#landing-ui{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}
input{
  padding:15px;
  width:320px;
  font-size:16px;
  margin-bottom:10px;
}
button{
  padding:12px 30px;
  font-size:16px;
}
.embeddedservice_bootstrap .embeddedMessagingFrame{
  position:fixed!important;
  top:0!important;
  left:0!important;
  width:100vw!important;
  height:100vh!important;
  border:none!important;
}
</style>
</head>

<body>

<div id="landing-ui">
  <h1>Ask Agentforce</h1>
  <input id="agentInput" placeholder="Type your question..." autocomplete="off"/>
  <button id="sendBtn" disabled>Loading Agent...</button>
  <p id="statusMsg">Initializing...</p>
</div>

<script>
/* ========= GLOBAL STATE ========= */
let userInitiated = false;
let queuedMessage = "";
let agentReady = false;

/* ========= LOGGER ========= */
function log(msg){
  const t = new Date().toISOString().split('T')[1].slice(0,-1);
  console.log("%c["+t+"] "+msg,"color:green;font-weight:bold;");
  document.getElementById("statusMsg").innerText = msg;
}

/* ========= CONFIG BEFORE INIT ========= */
function initESW(){
  embeddedservice_bootstrap.settings.language = "en_US";
  embeddedservice_bootstrap.settings.displayMode = "inline";
  embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;
  embeddedservice_bootstrap.settings.disableAutoSessionRestore = true;

  attachEvents();

  embeddedservice_bootstrap.init(
    "00DTA00000B1e6j",
    "Web_AI_Agent",
    "https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563",
    { scrt2URL:"https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com" }
  );
}

/* ========= SALESFORCE EVENTS ========= */
function attachEvents(){

  window.addEventListener("onEmbeddedMessagingReady",()=>{
    log("Event: Ready");
    agentReady = true;
    document.getElementById("sendBtn").disabled = false;
    document.getElementById("sendBtn").innerText = "Ask Agent";
  });

  window.addEventListener("onEmbeddedMessagingConversationOpened",()=>{
    log("Event: ConversationOpened");

    // ðŸ”´ Ignore restores and background loads
    if(!userInitiated){
      log("Ignoring â€” user did not start this");
      return;
    }

    document.getElementById("landing-ui").style.display="none";
  });

  window.addEventListener("onEmbeddedMessagingConversationStarted",()=>{
    log("Event: ConversationStarted");

    if(!userInitiated) return;

    if(queuedMessage){
      log("Sending message: "+queuedMessage);

      setTimeout(()=>{
        embeddedservice_bootstrap.utilAPI.sendTextMessage(queuedMessage)
          .then(()=>log("Message sent"))
          .catch(e=>log("Send failed: "+e));
        queuedMessage="";
      },500);
    }
  });

  window.addEventListener("onEmbeddedMessagingWindowClosed",()=>{
    log("Event: WindowClosed â†’ restoring UI");

    userInitiated = false;
    queuedMessage = "";

    document.getElementById("landing-ui").style.display="flex";
    document.getElementById("agentInput").value="";
  });
}

/* ========= WAIT FOR BOOTSTRAP ========= */
const wait = setInterval(()=>{
  if(window.embeddedservice_bootstrap){
    clearInterval(wait);
    initESW();
  }
},50);

/* ========= USER ACTION ========= */
document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("sendBtn");
  const input=document.getElementById("agentInput");

  input.addEventListener("input",()=>{
    btn.disabled = !(input.value.trim() && agentReady);
  });

  function startChat(){
    const text=input.value.trim();
    if(!text) return;

    userInitiated = true;
    queuedMessage = text;

    log("User clicked â†’ launching chat");

    embeddedservice_bootstrap.utilAPI.launchChat()
      .then(()=>log("launchChat called"))
      .catch(e=>log("launchChat error: "+e));
  }

  btn.addEventListener("click",startChat);
  input.addEventListener("keydown",e=>{
    if(e.key==="Enter") startChat();
  });
});
</script>

<script src="https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563/assets/js/bootstrap.min.js"></script>

</body>
</html>
