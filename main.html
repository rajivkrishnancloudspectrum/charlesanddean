<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Agentforce Fixed Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">

<style>
  body { margin: 0; padding: 0; height: 100vh; width: 100vw; font-family: sans-serif; background: #f4f6f9; }
  
  /* LANDING UI STYLES */
  #landing-ui {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    transition: opacity 0.3s ease;
  }

  h1 { color: #003e6b; margin-bottom: 20px; }
  
  input {
    padding: 15px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    margin-bottom: 10px;
  }

  button {
    padding: 12px 30px;
    background-color: #0070d2;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s;
  }

  button:disabled { background-color: #c9c7c5; cursor: not-allowed; }
  button:hover:not(:disabled) { background-color: #005fb2; }

  #statusMsg { margin-top: 20px; color: #555; font-size: 14px; min-height: 20px;}

  /* * FIX #1: CSS SELECTOR 
   * Use a space! .class1 .class2 means "class2 inside class1"
   */
  .embeddedservice_bootstrap .embeddedMessagingFrame {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    border: none !important;
    z-index: 9999 !important;
    margin: 0 !important;
  }
</style>
</head>

<body>

<div id="landing-ui">
  <h1>Agentforce Debug UI</h1>
  <input id="agentInput" placeholder="Type your request..." autocomplete="off" />
  <button id="searchBtn" disabled>Send</button>
  <p id="statusMsg">Loading Agentforce...</p>
</div>

<script>
/**
 * STATE MANAGEMENT
 */
let capturedInput = ""; 
let isAgentReady = false;

// Logger utility to track exact timing of events
function log(msg) {
  const time = new Date().toISOString().split('T')[1].slice(0, -1);
  console.log(`%c[${time}] ${msg}`, "color: #0070d2; font-weight: bold;");
  // Optional: Update status text on screen for visibility
  const statusEl = document.getElementById("statusMsg");
  if(statusEl) statusEl.innerText = msg;
}

/**
 * 1. INITIALIZATION LOOP
 * Waits for the global embeddedservice_bootstrap object to exist.
 */
const initInterval = setInterval(() => {
  if (window.embeddedservice_bootstrap) {
    clearInterval(initInterval);
    log("Bootstrap detected. Configuring...");
    setupEmbeddedMessaging();
  }
}, 50);

function setupEmbeddedMessaging() {
  try {
    // Configuration settings
    embeddedservice_bootstrap.settings.language = "en_US";
    embeddedservice_bootstrap.settings.displayMode = "inline";
    embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;
    embeddedservice_bootstrap.settings.disableAutoSessionRestore = true; // Prevents old chats from popping up

    // Attach Event Listeners BEFORE init
    attachEventListeners();

    // Initialize Salesforce
    embeddedservice_bootstrap.init(
      "00DTA00000B1e6j",
      "Web_AI_Agent",
      "https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563",
      { scrt2URL: "https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com" }
    );
  } catch (error) {
    log("Error during setup: " + error.message);
  }
}

/**
 * 2. EVENT LISTENERS (The Fix)
 */
function attachEventListeners() {
  
  // A. READY: Just enables the UI. Don't send messages here.
  window.addEventListener("onEmbeddedMessagingReady", () => {
    log("Event: Ready. Enabling UI.");
    isAgentReady = true;
    const btn = document.getElementById("searchBtn");
    const input = document.getElementById("agentInput");
    
    if(btn) btn.disabled = false;
    if(input) input.focus();
    
    document.getElementById("statusMsg").innerText = "Agent Ready. Type to start.";
  });

  // B. OPENED: The UI is visible. Hide our landing page.
  window.addEventListener("onEmbeddedMessagingConversationOpened", () => {
    log("Event: Conversation Opened. Hiding Landing UI.");
    document.getElementById("landing-ui").style.display = "none";
  });

  // C. STARTED: The session is active. THIS is where we send.
  window.addEventListener("onEmbeddedMessagingConversationStarted", () => {
    log("Event: Conversation Started.");
    
    if (capturedInput) {
      log(`Sending captured message: "${capturedInput}"`);
      // Add a tiny safety delay (50ms) to ensure message bus is connected
      setTimeout(() => {
          embeddedservice_bootstrap.utilAPI.sendTextMessage(capturedInput)
            .then(() => {
                log("Message sent successfully.");
                capturedInput = ""; // Clear buffer
            })
            .catch(err => log("Failed to send message: " + err));
      }, 100);
    } else {
        log("No captured input to send.");
    }
  });

  // D. CLOSED: User closed chat. Reset UI.
  window.addEventListener("onEmbeddedMessagingWindowClosed", () => {
    log("Event: Window Closed. Restoring UI.");
    document.getElementById("landing-ui").style.display = "flex";
    document.getElementById("agentInput").value = "";
    document.getElementById("statusMsg").innerText = "Session Ended. Ready for new chat.";
    capturedInput = "";
  });
}

/**
 * 3. USER INTERACTION
 */
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("searchBtn");
  const input = document.getElementById("agentInput");

  // Handle Input Typing
  input.addEventListener("input", (e) => {
    // Only enable button if text exists AND agent is initialized
    btn.disabled = !(e.target.value.trim().length > 0 && isAgentReady);
  });

  // Handle "Enter" key
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !btn.disabled) {
      triggerChat();
    }
  });

  // Handle Button Click
  btn.addEventListener("click", triggerChat);

  function triggerChat() {
    const text = input.value.trim();
    if (!text) return;

    capturedInput = text;
    log("User clicked send. Launching chat...");
    
    // Launch the chat. Logic is now handed off to Event Listeners B & C.
    embeddedservice_bootstrap.utilAPI.launchChat()
      .then(() => log("launchChat() called successfully."))
      .catch((e) => log("launchChat() failed: " + e));
  }
});

</script>

<script src="https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563/assets/js/bootstrap.min.js"></script>

</body>
</html>
