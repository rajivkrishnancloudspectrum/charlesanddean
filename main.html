<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Agentforce Debug Portal</title>

<style>
body{margin:0;padding:0;height:100vh;width:100vw;font-family:sans-serif;}
#landing-ui{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
.embeddedservice_bootstrap .embeddedMessagingFrame{
  position:fixed!important;top:0!important;left:0!important;
  width:100vw!important;height:100vh!important;border:none!important;
}
</style>
</head>

<body>

<div id="landing-ui">
  <h1>Agentforce Debug UI</h1>
  <input id="agentInput" placeholder="Type your request..." />
  <button id="searchBtn" disabled>Send</button>
  <p id="statusMsg">Initializing Agent…</p>
</div>

<script>
let capturedInput = "";
let chatLaunched = false;
let waitingToSend = false;
let readyCount = 0;

function log(msg){
  console.log(
    "%c[DEBUG " + new Date().toISOString().split('T')[1] + "] " + msg,
    "color:green;font-weight:bold;"
  );
}

/* ================= SAFE SINGLE INIT ================= */
function safeInit(){
  if(window.eswInitialized){
    log("ESW already initialized — skipping");
    return;
  }
  if(!window.embeddedservice_bootstrap){
    log("ESW bootstrap not present yet");
    return;
  }

  window.eswInitialized = true;
  log("safeInit() → initEmbeddedMessaging()");
  initEmbeddedMessaging();
}

function initEmbeddedMessaging(){

  log("initEmbeddedMessaging() called");

  embeddedservice_bootstrap.settings.language = "en_US";
  embeddedservice_bootstrap.settings.hideChatButtonOnLoad = true;
  embeddedservice_bootstrap.settings.disableAutoSessionRestore = true;
  embeddedservice_bootstrap.settings.displayMode = "inline";

  log("Settings applied BEFORE init");

  /* ========== ESW EVENTS ========== */

  window.addEventListener("onEmbeddedMessagingReady", () => {
    readyCount++;
    log("Event: onEmbeddedMessagingReady → count: " + readyCount);

    if(!chatLaunched){
      log("Ready #1 → enabling UI");
      document.getElementById("searchBtn").disabled = false;
      document.getElementById("statusMsg").innerText = "Agent Ready";
      return;
    }

    if(waitingToSend && capturedInput){
      log("Ready #2 → Chat UI ready → sending message: " + capturedInput);
      embeddedservice_bootstrap.utilAPI.sendTextMessage(capturedInput);
      capturedInput = "";
      waitingToSend = false;
    }
  });

  window.addEventListener("onEmbeddedMessagingConversationOpened", () => {
    log("Event: ConversationOpened");
    document.getElementById("landing-ui").style.display = "none";
    waitingToSend = true;
    log("waitingToSend set → " + waitingToSend);
  });

  window.addEventListener("onEmbeddedMessagingWindowMinimized", () => {
    log("Event: WindowMinimized");
    restoreUI("WindowMinimized");
  });

  window.addEventListener("onEmbeddedMessagingWindowClosed", () => {
    log("Event: WindowClosed");
    restoreUI("WindowClosed");
  });

  /* ========== INIT ESW ========== */

  embeddedservice_bootstrap.init(
    "00DTA00000B1e6j",
    "Web_AI_Agent",
    "https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563",
    { scrt2URL: "https://charlesdean--partialcop.sandbox.my.salesforce-scrt.com" }
  );

  log("embeddedservice_bootstrap.init() called");
}

function restoreUI(source){
  log("restoreUI() triggered by: " + source);
  chatLaunched = false;
  waitingToSend = false;
  document.getElementById("landing-ui").style.display = "flex";
}

/* ================= USER INTERACTION ================= */
document.addEventListener("DOMContentLoaded", () => {

  log("DOM fully loaded");

  const btn = document.getElementById("searchBtn");
  const input = document.getElementById("agentInput");

  input.addEventListener("input", () => {
    log("Typing: " + input.value);
    btn.disabled = !input.value.trim();
  });

  const startChat = () => {
    log("startChat() triggered");

    if(chatLaunched){
      log("Chat already launched — ignoring");
      return;
    }

    if(!window.embeddedservice_bootstrap?.utilAPI){
      log("utilAPI not ready yet");
      return;
    }

    const text = input.value.trim();
    if(!text){
      log("No text entered");
      return;
    }

    capturedInput = text;
    input.value = "";
    chatLaunched = true;

    log("Calling launchChat()");

    embeddedservice_bootstrap.utilAPI.launchChat()
      .then(() => log("launchChat() resolved"))
      .catch(err => log("launchChat() error: " + err))
      .finally(() => log("launchChat() finished"));
  };

  btn.addEventListener("click", startChat);
  input.addEventListener("keydown", e => {
    if(e.key === "Enter"){
      log("Enter key pressed");
      startChat();
    }
  });
});

/* ===== Wait for ESW bootstrap, then init ONCE ===== */
const waitForESW = setInterval(()=>{
  if(window.embeddedservice_bootstrap){
    clearInterval(waitForESW);
    log("ESW bootstrap detected");
    safeInit();
  }
},100);
</script>

<script src="https://charlesdean--partialcop.sandbox.my.site.com/ESWWebAIAgent1762338692563/assets/js/bootstrap.min.js"></script>

</body>
</html>
